<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>{% if form.instance.pk %}Редактировать{% else %}Создать{% endif %} договор</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .inline-form { border: 1px solid #dee2e6; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
    </style>
</head>
<body class="bg-light">
{% load crispy_forms_tags %}
<div class="container mt-4">

    <h1>{% if form.instance.pk %}Редактировать{% else %}Создать{% endif %} договор</h1>

    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <div class="row">
            <div class="col-md-8">

                <!-- Заказчик -->
                <div class="card mb-3">
                    <div class="card-header">Заказчик</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">{{ form.customer_name|as_crispy_field }}</div>
                            <div class="col-md-6">{{ form.customer_inn|as_crispy_field }}</div>
                        </div>
                    </div>
                </div>

                <!-- Сроки -->
                <div class="card mb-3">
                    <div class="card-header">Сроки</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">{{ form.start_date|as_crispy_field }}</div>
                            <div class="col-md-6">{{ form.end_date|as_crispy_field }}</div>
                        </div>
                    </div>
                </div>

                <!-- Исполнитель -->
                <div class="card mb-3">
                    <div class="card-header">Исполнитель</div>
                    <div class="card-body">
                        {{ form.implementator|as_crispy_field }}
                    </div>
                </div>

                <!-- Чек-лист -->
                <div class="card mb-3">
                    <div class="card-header">Чек-лист</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">{{ form.gos_services|as_crispy_field }}</div>
                            <div class="col-md-4">{{ form.oko|as_crispy_field }}</div>
                            <div class="col-md-4">{{ form.spolokh|as_crispy_field }}</div>
                        </div>
                    </div>
                </div>

                <!-- Файлы -->
                <div class="card mb-3">
                    <div class="card-header">Файлы (обязателен хотя бы один)</div>
                    <div class="card-body">
                        {{ form.file1|as_crispy_field }}
                        {{ form.file2|as_crispy_field }}
                        {{ form.file3|as_crispy_field }}
                    </div>
                </div>

                <!-- АК -->
                <div class="card mb-3">
                    <div class="card-header">
                        Абонентские комплекты (АК)
                        <button type="button" class="btn btn-sm btn-outline-primary float-end" onclick="addAK()">+ Добавить</button>
                    </div>
                    <div class="card-body">
                        {{ ak_formset.management_form }}
                        <div id="ak-container">
                            {% for form in ak_formset %}
                            <div class="inline-form bg-white mb-2">
                                {{ form.id }}
                                <div class="row">
                                    <div class="col-md-3">{{ form.number|as_crispy_field }}</div>
                                    <div class="col-md-4">{{ form.district|as_crispy_field }}</div>
                                    <div class="col-md-4">{{ form.address|as_crispy_field }}</div>
                                    <div class="col-md-1">{{ form.DELETE|as_crispy_field }}</div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn btn-success btn-lg">Сохранить</button>
                <a href="{% url 'contracts:contract_list' %}" class="btn btn-secondary btn-lg">Отмена</a>

            </div>
        </div>
    </form>
</div>

<!-- Пустая форма для клонирования -->
<div id="empty-ak-form" style="display:none;">
    <div class="inline-form bg-white mb-2">
        <div class="row">
            <div class="col-md-3"><input type="number" name="aks-__prefix__-number" class="form-control" min="1" max="99999999"></div>
            <div class="col-md-4"><select name="aks-__prefix__-district" class="form-select"></select></div>
            <div class="col-md-4"><input type="text" name="aks-__prefix__-address" class="form-control"></div>
            <div class="col-md-1"><input type="checkbox" name="aks-__prefix__-DELETE"></div>
        </div>
    </div>
</div>

<script>
function addAK() {
    const total = document.querySelector('#id_aks-TOTAL_FORMS');
    const idx = parseInt(total.value);
    const tmpl = document.querySelector('#empty-ak-form').innerHTML.replace(/__prefix__/g, idx);
    document.querySelector('#ak-container').insertAdjacentHTML('beforeend', tmpl);
    total.value = idx + 1;
}
</script>
</body>
</html>