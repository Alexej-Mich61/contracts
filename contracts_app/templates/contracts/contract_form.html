<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>{% if form.instance.pk %}Редактировать{% else %}Создать{% endif %} договор</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .inline-form { border: 1px solid #dee2e6; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .inline-form .form-control { margin-bottom: 10px; }
    </style>
</head>
<body class="bg-light">
{% load crispy_forms_tags %}
<div class="container mt-4">

    <h1>{% if form.instance.pk %}Редактировать{% else %}Создать{% endif %} договор</h1>

    <form method="post" enctype="multipart/form-data" novalidate>
        {% csrf_token %}

        <div class="row">
            <div class="col-md-8">

                <!-- Основные поля -->
                <div class="card mb-3">
                    <div class="card-header">Заказчик</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                {{ form.customer_name|as_crispy_field }}
                            </div>
                            <div class="col-md-6">
                                {{ form.customer_inn|as_crispy_field }}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-header">Сроки</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                {{ form.start_date|as_crispy_field }}
                            </div>
                            <div class="col-md-6">
                                {{ form.end_date|as_crispy_field }}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-header">Исполнитель</div>
                    <div class="card-body">
                        {{ form.implementator|as_crispy_field }}
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-header">Чек-лист</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                {{ form.gos_services|as_crispy_field }}
                            </div>
                            <div class="col-md-4">
                                {{ form.oko|as_crispy_field }}
                            </div>
                            <div class="col-md-4">
                                {{ form.spolokh|as_crispy_field }}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-header">Файлы (1–3, до 20 МБ)</div>
                    <div class="card-body">
                        {{ form.file1|as_crispy_field }}
                        {{ form.file2|as_crispy_field }}
                        {{ form.file3|as_crispy_field }}
                    </div>
                </div>

                <!-- АК Инлайны -->
                <div class="card mb-3">
                    <div class="card-header">
                        Абонентские комплекты (АК) — {{ ak_formset.total_form_count }}
                        <a href="#" class="btn btn-sm btn-outline-primary float-end" onclick="addAKForm(); return false;">+ Добавить</a>
                    </div>
                    <div class="card-body">
                        {{ ak_formset.management_form }}
                        <div id="ak-forms">
                            {% for form in ak_formset %}
                            <div class="inline-form bg-white">
                                {{ form.id }}
                                <div class="row">
                                    <div class="col-md-3">
                                        {{ form.number|as_crispy_field }}
                                    </div>
                                    <div class="col-md-4">
                                        {{ form.district|as_crispy_field }}
                                    </div>
                                    <div class="col-md-4">
                                        {{ form.address|as_crispy_field }}
                                    </div>
                                    <div class="col-md-1">
                                        {{ form.DELETE|as_crispy_field }}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn btn-success btn-lg">Сохранить</button>
                <a href="{% url 'contracts:contract_list' %}" class="btn btn-secondary btn-lg">Отмена</a>

            </div>
        </div>
    </form>
</div>

<script>
function addAKForm() {
    const formIdx = $('#id_aks-TOTAL_FORMS').val();
    const emptyForm = $('#empty-form').html().replace(/__prefix__/g, formIdx);
    $('#ak-forms').append(emptyForm);
    $('#id_aks-TOTAL_FORMS').val(parseInt(formIdx) + 1);
}
</script>

<!-- Шаблон пустой формы -->
<div id="empty-form" style="display: none;">
    <div class="inline-form bg-white">
        <div class="row">
            <div class="col-md-3">
                <label>Номер АК</label>
                <input type="number" name="aks-__prefix__-number" class="form-control" min="1" max="99999999">
            </div>
            <div class="col-md-4">
                <label>Район</label>
                <select name="aks-__prefix__-district" class="form-select"></select>
            </div>
            <div class="col-md-4">
                <label>Адрес</label>
                <input type="text" name="aks-__prefix__-address" class="form-control">
            </div>
            <div class="col-md-1">
                <label>Удалить</label>
                <input type="checkbox" name="aks-__prefix__-DELETE">
            </div>
        </div>
    </div>
</div>
</body>
</html>